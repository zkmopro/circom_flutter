# Circom Flutter

`circom_flutter` is a Flutter package for generating and verifying [Circom](https://github.com/iden3/circom) zero-knowledge proofs using the groth16 backend.

The Swift bindings are generated by the [**mopro CLI**](https://zkmopro.org/docs/getting-started) using the **Circom adapter**, which utilizes [`circom-prover`](https://github.com/zkmopro/mopro/tree/main/circom-prover) with [`circom-witnesscalc`](https://github.com/iden3/circom-witnesscalc) for witness generation and [`arkworks`](https://github.com/arkworks-rs) for groth16 proof construction.

To learn more about the original Rust implementation before generating bindings, please refer to [zkmopro documentation](https://zkmopro.org/docs/getting-started).

> [!NOTE]  
> To use `circom-witnesscalc`, follow the [README instructions](https://github.com/iden3/circom-witnesscalc?tab=readme-ov-file#compile-a-circuit-and-build-the-witness-graph) to generate the **graph file** from your Circom circuits.
> Or the [script](https://github.com/semaphore-protocol/semaphore-rs/blob/ccf81861d4f10f196d3c705746003c54611fe784/script/build_witness_graph.sh#L38) from [`semaphore-rs`](https://github.com/semaphore-protocol/semaphore-rs)

## How to Import the Package

### Adding a package dependency to an app

1.  **Manual Edit (Required for local path or specific Git dependencies):**
    Open your `pubspec.yaml` file and add `circom_flutter` under `dependencies`.

          ```yaml
          dependencies:
              flutter:
                  sdk: flutter

              circom_flutter:
                  git:
                      url: https://github.com/zkmopro/circom_flutter
              # Or
              # circom_flutter:
              #    path: ../circom_flutter
          ```

2.  **Update Circuit Asset:** Include your compiled Circom circuit `.zkey` and `.bin` file as an asset. Add the asset path to your `pubspec.yaml` under the `flutter:` section:

    ```yaml
    flutter:
        uses-material-design: true # Ensure this is present
        assets:
            # Add the directory containing your circom circuit file(s)
            - assets/....zkey
            - assets/....bin
            # Or specify the file directly:
            # - assets/multiplier2_final.zkey
    ```

    _Make sure the path points correctly to where you've placed your `.zkey` and `.bin` file within your Flutter project._

3.  **Install Package:** Run the following command in your terminal from the root of your Flutter project:

    ```bash
    flutter pub get
    ```

## How to Use the Package

### Import the package

```dart
import 'package:circom_flutter/src/rust/third_party/circom_prover_bindings.dart';
import 'package:circom_flutter/src/rust/frb_generated.dart';
```

Update the main function to initialize the Rust library before running the app:

```dart
void main() async {
  await RustLib.init();
  runApp(const MyApp());
}
```

### Load graph and zkey

Please checkout [`circom`](https://docs.circom.io/getting-started/proving-circuits/#phase-2) and [`circom-witensscalc`](https://github.com/iden3/circom-witnesscalc?tab=readme-ov-file#compile-a-circuit-and-build-the-witness-graph) to see how to generate the zkey and the graph.

```dart
final zkeyPath = await copyAssetToFileSystem(
      'assets/multiplier2_final.zkey');
final graphPath = await copyAssetToFileSystem(
      'assets/multiplier2.bin');
```

> [!NOTE]
> To learn how to read a file from an app, please refer to the [`copyAssetToFileSystem`](https://github.com/zkmopro/flutter-app/blob/a36ef9a78b35ea2618dafd4224c4f60e014e2e10/lib/main.dart#L584) function in the Flutter app.

### `circomProve`

```dart
var inputs = '{"a":["3"],"b":["5"]}';

final proof = await circomProve(
    graphPath: graphPath,
    inputs: inputs,
    zkeyPath: zkeyPath,
);
```

### `verifyCircomProof`

```swift
final isValid = await verifyCircomProof(
    zkeyPath: zkeyPath,
    proofResult: proof,
    proofLib: ProofLib.arkworks,
);
```

## How to Build the Package

1. Use `mopro-cli` and choose `circom`

```sh
mopro init
```

choose `circom`

Update the `circom-prover` resource in `Cargo.toml`

```toml
circom-prover = { git = "https://github.com/zkmopro/mopro", branch = "circom-witnesscalc-path", features = [
    "circom-witnesscalc",
] }
```

and run

```sh
mopro build
```

choose `flutter`.

### Flutter Example App

- Open the example app that uses the defined flutter package in the [`example/`](example) folder
    ```sh
    cd example
    ```
- Install the dependencies
    ```sh
    flutter pub get
    ```
- Open an iOS simulator/device or an Android emulator/device and run the example app
    ```sh
    flutter run
    ```
- Clean the cache if you update the bindings and it throws errors
    ```sh
    flutter clean
    ```

> ![WARNING]
> Bindings generated by the mopro CLI use local crate paths by default, which makes them non-reproducible on other devices.
> To make the build reproducible, publish your Rust crate and reference it via a Git source instead of a local path at [here](https://github.com/vivianjeng/mopro_flutter_package/blob/983ebcb60103c961c870634d3f3df54d6d6dc564/rust/Cargo.toml#L7).
> If you’d like to help address this limitation, contributions are welcome — see https://github.com/zkmopro/mopro/issues/647
> .

## Community

- X account: <a href="https://twitter.com/zkmopro"><img src="https://img.shields.io/twitter/follow/zkmopro?style=flat-square&logo=x&label=zkmopro"></a>
- Telegram group: <a href="https://t.me/zkmopro"><img src="https://img.shields.io/badge/telegram-@zkmopro-blue.svg?style=flat-square&logo=telegram"></a>

## Acknowledgements

This work was initially sponsored by a joint grant from [PSE](https://pse.dev/) and [0xPARC](https://0xparc.org/). It is currently incubated by PSE.
